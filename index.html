<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å½±ç‰‡å½±æ ¼æª¢è¦–å™¨ï¼ˆå¯è¨­å®šFPSï¼‰</title>
<style>
body {
  font-family: sans-serif;
  background: #111;
  color: white;
  text-align: center;
  overflow: hidden;
  margin: 0;
}
#controls {
  margin: 10px 0;
}
#viewer {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 80vh;
  position: relative;
}
canvas {
  max-width: 90%;
  max-height: 90%;
  border: 1px solid #444;
  border-radius: 8px;
  box-shadow: 0 0 10px #000;
}
#counter {
  position: absolute;
  bottom: 10px;
  right: 20px;
  font-size: 18px;
  opacity: 0.8;
}
input[type=number] {
  width: 60px;
  padding: 3px;
  border-radius: 4px;
  border: 1px solid #444;
  background: #222;
  color: white;
}
</style>
</head>
<body>
<h2>ğŸ¬ ä¸Šå‚³å½±ç‰‡ä¸¦é€å½±æ ¼ç€è¦½</h2>
<div id="controls">
  <input type="file" id="upload" accept="video/*">
  æ¯ç§’å½±æ ¼æ•¸ (FPS)ï¼š<input type="number" id="fpsInput" value="10" min="1" max="60">
</div>
<p id="status">è«‹é¸æ“‡å½±ç‰‡æª”æ¡ˆä¸¦è¨­å®šFPSã€‚</p>
<div id="viewer">
  <canvas id="frameCanvas"></canvas>
  <div id="counter">0 / 0</div>
</div>

<script>
const upload = document.getElementById('upload');
const fpsInput = document.getElementById('fpsInput');
const statusText = document.getElementById('status');
const frameCanvas = document.getElementById('frameCanvas');
const ctx = frameCanvas.getContext('2d');
const counter = document.getElementById('counter');

let frames = [];
let currentIndex = 0;

upload.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  frames = [];
  currentIndex = 0;
  const fps = Math.max(1, Math.min(60, parseInt(fpsInput.value))) || 10;
  statusText.textContent = 'æ“·å–å½±æ ¼ä¸­...è«‹ç¨å€™';

  const url = URL.createObjectURL(file);
  const video = document.createElement('video');
  video.src = url;
  video.muted = true;
  video.playsInline = true;
  await video.play().catch(()=>{});
  video.pause();

  const duration = video.duration;
  const interval = 1 / fps;
  const tempCanvas = document.createElement('canvas');
  const tempCtx = tempCanvas.getContext('2d');
  tempCanvas.width = video.videoWidth;
  tempCanvas.height = video.videoHeight;

  let t = 0;
  while (t < duration) {
    video.currentTime = t;
    await new Promise(r => video.onseeked = r);
    tempCtx.drawImage(video, 0, 0);
    const img = new Image();
    img.src = tempCanvas.toDataURL('image/jpeg', 0.8);
    frames.push(img);
    t += interval;
  }

  URL.revokeObjectURL(url);
  statusText.textContent = `æ“·å–å®Œæˆï¼Œå…± ${frames.length} å½±æ ¼ã€‚æ»‘å‹•æˆ–æŒ‰æ–¹å‘éµåˆ‡æ›ã€‚`;
  showFrame(0);
});

function showFrame(index) {
  if (frames.length === 0) return;
  currentIndex = Math.max(0, Math.min(index, frames.length - 1));
  const img = frames[currentIndex];
  frameCanvas.width = img.width;
  frameCanvas.height = img.height;
  ctx.clearRect(0, 0, frameCanvas.width, frameCanvas.height);
  ctx.drawImage(img, 0, 0);
  counter.textContent = `${currentIndex + 1} / ${frames.length}`;
}

// å·¦å³éµåˆ‡æ›
document.addEventListener('keydown', e => {
  if (frames.length === 0) return;
  if (e.key === 'ArrowRight') showFrame(currentIndex + 1);
  if (e.key === 'ArrowLeft') showFrame(currentIndex - 1);
});

// è§¸æ§æ»‘å‹•åˆ‡æ›
let startX = 0;
document.addEventListener('touchstart', e => {
  startX = e.touches[0].clientX;
});
document.addEventListener('touchend', e => {
  const endX = e.changedTouches[0].clientX;
  const diff = endX - startX;
  if (Math.abs(diff) > 50) {
    if (diff < 0) showFrame(currentIndex + 1);
    else showFrame(currentIndex - 1);
  }
});
</script>
</body>
</html>
